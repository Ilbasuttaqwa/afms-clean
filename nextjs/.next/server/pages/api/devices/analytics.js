"use strict";(()=>{var e={};e.id=9562,e.ids=[9562],e.modules={3524:e=>{e.exports=require("@prisma/client")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},1674:(e,t,a)=>{a.r(t),a.d(t,{config:()=>m,default:()=>g,routeModule:()=>p});var n={};a.r(n),a.d(n,{default:()=>_});var r=a(1802),s=a(7153),i=a(6249),c=a(3524);!function(){var e=Error("Cannot find module '../../../lib/auth-middleware'");throw e.code="MODULE_NOT_FOUND",e}();let o=new c.PrismaClient;async function l(e,t){try{switch(e.method){case"GET":return await u(e,t);case"POST":return await d(e,t);default:return t.status(405).json({success:!1,message:"Method not allowed"})}}catch(e){return t.status(500).json({success:!1,message:"Terjadi kesalahan server"})}finally{await o.$disconnect()}}async function u(e,t){let{device_ids:a,cabang_id:n,start_date:r,end_date:s,metrics:i=["uptime","sync","hardware"],group_by:c="device"}=e.query,l=s?new Date(s):new Date,u=new Date(r||l.getTime()-2592e6);try{let e={};if(a){let t=Array.isArray(a)?a:[a];e.device_id={in:t}}n&&(e.cabang_id=parseInt(n));let r=await o.device.findMany({where:e,include:{cabang:!0,statusLogs:{where:{timestamp:{gte:u,lte:l}},orderBy:{timestamp:"asc"}}}}),s=[];for(let e of r){let t=e.statusLogs,a=t.length,n=t.filter(e=>"online"===e.status),r=a>0?n.length/a*100:0,i=t.filter(e=>null!==e.storage_usage),c=i.length>0?i.reduce((e,t)=>e+(t.storage_usage||0),0)/i.length:0,o=t.filter(e=>null!==e.error_message).length,d=Math.round(.4*r+0+.3*Math.max(0,100-5*o)),_=new Date((u.getTime()+l.getTime())/2),g=t.filter(e=>e.timestamp<_),m=t.filter(e=>e.timestamp>=_),p=g.length>0?g.filter(e=>"online"===e.status).length/g.length*100:0,y=m.length>0?m.filter(e=>"online"===e.status).length/m.length*100:0,h=y>p+5?"improving":y<p-5?"declining":"stable",f={device_id:e.device_id,device_name:e.nama,cabang_name:e.cabang?.nama_cabang||"Unknown",period:`${u.toISOString().split("T")[0]} to ${l.toISOString().split("T")[0]}`,metrics:{uptime_percentage:Math.round(100*r)/100,total_syncs:0,successful_syncs:0,failed_syncs:0,avg_sync_duration:Math.round(0)/100,total_records_synced:0,avg_battery_level:Math.round(0)/100,avg_temperature:Math.round(0)/100,avg_memory_usage:Math.round(0)/100,avg_storage_usage:Math.round(100*c)/100,error_count:o,connection_quality_score:d},trends:{uptime_trend:h,sync_performance_trend:"stable",hardware_health_trend:"stable"}};s.push(f)}let i=s.length,c=i>0?s.reduce((e,t)=>e+t.metrics.uptime_percentage,0)/i:0,d=i>0?s.reduce((e,t)=>e+t.metrics.connection_quality_score,0)/i:0,_=s.reduce((e,t)=>e+t.metrics.total_syncs,0),g=s.reduce((e,t)=>e+t.metrics.successful_syncs,0),m=s.reduce((e,t)=>e+t.metrics.total_records_synced,0);return t.status(200).json({success:!0,data:{analytics:s,summary:{total_devices:i,avg_uptime_percentage:Math.round(100*c)/100,avg_connection_quality_score:Math.round(100*d)/100,total_syncs:_,total_successful_syncs:g,sync_success_rate:_>0?Math.round(g/_*1e4)/100:0,total_records_synced:m,period:`${u.toISOString().split("T")[0]} to ${l.toISOString().split("T")[0]}`,generated_at:new Date}}})}catch(e){return t.status(500).json({success:!1,message:e.message||"Gagal mengambil analitik"})}}async function d(e,t){let{device_ids:a,cabang_id:n,start_date:r,end_date:s,report_type:i="summary",format:c="json"}=e.body;try{let e={report_id:`report_${Date.now()}`,report_type:i,generated_at:new Date,period:{start_date:r||new Date(Date.now()-2592e6).toISOString().split("T")[0],end_date:s||new Date().toISOString().split("T")[0]},filters:{device_ids:a||"all",cabang_id:n||"all"},summary:{total_devices_analyzed:0,avg_uptime:0,total_syncs:0,sync_success_rate:0,total_errors:0},recommendations:[{priority:"high",category:"performance",description:"Consider upgrading devices with consistently low battery levels",affected_devices:[]},{priority:"medium",category:"maintenance",description:"Schedule regular sync operations for devices with low sync frequency",affected_devices:[]}]};return t.status(200).json({success:!0,message:"Laporan berhasil dibuat",data:e})}catch(e){return t.status(500).json({success:!1,message:e.message||"Gagal membuat laporan"})}}let _=Object(function(){var e=Error("Cannot find module '../../../lib/auth-middleware'");throw e.code="MODULE_NOT_FOUND",e}())(l),g=(0,i.l)(n,"default"),m=(0,i.l)(n,"config"),p=new r.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/devices/analytics",pathname:"/api/devices/analytics",bundlePath:"",filename:""},userland:n})},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=1674);module.exports=a})();